## What is this?

[**Jila**](http://jilaframework.github.io) is a framework for building simple language learning apps. This particular repository is for the administrative backend and the API used to communicate with the app.

The **Jila** administration console is built using [Ruby on Rails](http://rubyonrails.org/) and the [ActiveAdmin](http://activeadmin.info/) framework.

## Prerequisites

- Ruby

## Installation

Install Ruby gems
`bundle install`

## Getting Started

### Development
Launch a Rails server however you wish, see their [documentation](http://guides.rubyonrails.org/getting_started.html) if you have any particular questions. The simplest way to launch it would be to run `bundle exec rails s` which will launch a server at 'http://localhost:3000'.

## Deployment
The backend is a fairly vanilla Ruby on Rails application, so hosting arrangements can be whatever suits the user. The team have been using [Heroku](http://www.heroku.com) for both development/testing and production environments. Asset storage (images and audio) is configured to use [Amazon Simple Storage Service (S3)](http://aws.amazon.com/s3/) for production-like environments, and the local file system for development.

The production environment uses [Paperclip](https://github.com/thoughtbot/paperclip) to upload the assets to S3. For each deployment environment you will have to set environment variables for the S3 bucket name, and the credentials, as outlined in **production.rb**.

## Customisation
The administration console is usable out of the box with no changes. If you do make changes, **please consider submitting a pull request so the community can benefit**.

--


## Dan's notes

### In setting this up I am going to (for now) make a running list of what worked and what didn't.

Amazon Regions generate s3 urls differently. So assuming you have got your bucket set up and ready
to receive your image assets, you may run into the problem of ActiveAdmin not being able to display
your image thumbnails. Since this particular setup is located in the Pacific North West region of
the united states, I opted for the uswest-2 region, which is located in Oregon. The problem is that
us-west-2 wants s3 urls to look like this:  
``http://<bucket-name>.s3-us-west-2.amazonaws.com/entries/images/000/000/005/thumbnail/<image file name>``

Whereas the region that would be used in Australia (s3-ap-southeast-2) wants them to look like this:  
``http://s3-ap-southeast-2.amazonaws.com/<bucket-name>/entries/images/000/000/005/thumbnail/<image file name>``

Which also happens to be the default way urls are generated by paperclip, the image handler. To fix this, I added the following to `/config/initializers/paperclip.rb`:
``
Paperclip::Attachment.default_options[:url] = ':s3_domain_url'  
Paperclip::Attachment.default_options[:path] = ":class/:attachment/:id_partition/:style/:filename"  
Paperclip::Attachment.default_options[:s3_host_name] = 's3-us-west-2.amazonaws.com'  ``

And for now it seems to be working.

--

On switching from sqlite to postgres:
You're gonna want to get your data out of sqlite and into postgres. The best way to do that is as follows:  
``sequel -C sqlite://development.sqlite3 postgres://user:password@localhost/jila_backend_dev``  
This assumes of course that you have the "sequel" gem installed. Sequel is a tool for editing databases from your shell of choice. You will also need to set up a postgres user that actually has a password, to run this command.

--
Some things I've noticed that could be a problem:  

- when paperclip uploads your image to s3, the directory structure (and thus the image links) it creates
end up looking like this: /**entries**/images/000/000/**005**/thumbnail/20151219_154318.jpg,
where that "005" is the number id number of the particular entry this image is for. This is not in the database though, all we have there is a space for the image file's name, "20151219_154318.jpg". What this tells us is that inside the admin interface, the images urls are being built dynamically in the code. This could conceivably be a problem if something funky happens with the database, resulting in changes to some entries' ids. This would result in broken image links. Maybe this is totally unlikely and not a problem, but it seems like it would be good to have a fallback, so if the url built in the code returns a 404 error, we can have "/entries/images/000/000/005/" for the entry, stored in "image_key" column that we would add to "entries".

- Oh also, when you click the link to download a .csv file of all the admin accounts, it leaves out the number of times logged in. This can be a problem when copying it into postgres.
